# logger.py
# ================================================================================
# MACH VII - ë¡œê¹… ì‹œìŠ¤í…œ
# í„°ë¯¸ë„(ì»¬ëŸ¬ ì¶œë ¥)ê³¼ íŒŒì¼(í…ìŠ¤íŠ¸ ì €ì¥)ì— ë™ì‹œì— ë¡œê·¸ë¥¼ ë‚¨ê¸°ëŠ” ëª¨ë“ˆì…ë‹ˆë‹¤.
# ================================================================================

import logging
import sys
import os
from datetime import datetime

class ColoredFormatter(logging.Formatter):
    """
    ë¡œê·¸ ë©”ì‹œì§€ì— ì´ëª¨ì§€ì™€ ìƒ‰ìƒì„ ì…í˜€ì„œ ë³´ê¸° ì¢‹ê²Œ ë§Œë“¤ì–´ì£¼ëŠ” í¬ë§¤í„° í´ë˜ìŠ¤ì…ë‹ˆë‹¤.
    ê¸°ë³¸ì ì¸ logging.Formatter ê¸°ëŠ¥ì„ ìƒì†ë°›ì•„ í™•ì¥í•˜ì˜€ìŠµë‹ˆë‹¤.
    """
    
    # í„°ë¯¸ë„ì—ì„œ ê¸€ì ìƒ‰ìƒì„ ë³€ê²½í•˜ê¸° ìœ„í•œ ANSI ì»¬ëŸ¬ ì½”ë“œì…ë‹ˆë‹¤.
    # \033[92mê³¼ ê°™ì€ ì½”ë“œê°€ í„°ë¯¸ë„ì— ì „ë‹¬ë˜ë©´ ê·¸ ë’¤ì˜ ê¸€ì ìƒ‰ìƒì´ ë°”ë€ë‹ˆë‹¤.
    COLORS = {
        'DEBUG': '\033[36m',      # ì²­ë¡ìƒ‰ (ìƒì„¸ ë¶„ì„ìš©)
        'INFO': '\033[92m',       # ì´ˆë¡ìƒ‰ (ì¼ë°˜ ì •ë³´)
        'WARNING': '\033[93m',    # ë…¸ë€ìƒ‰ (ì£¼ì˜ í•„ìš”)
        'ERROR': '\033[91m',      # ë¹¨ê°„ìƒ‰ (ì˜¤ë¥˜ ë°œìƒ)
        'CRITICAL': '\033[95m'    # ë³´ë¼ìƒ‰ (ì‹¬ê°í•œ ìƒí™©)
    }
    # ìƒ‰ìƒ ì„¤ì •ì„ ì´ˆê¸°í™”í•˜ê³  ê¸°ë³¸ ìƒ‰ìƒìœ¼ë¡œ ë˜ëŒë¦¬ëŠ” ì½”ë“œì…ë‹ˆë‹¤.
    RESET = '\033[0m'
    
    # ê° ëª¨ë“ˆ(ê¸°ëŠ¥)ì˜ ì„±ê²©ì— ë§ëŠ” ì´ëª¨ì§€ ë§¤í•‘ì…ë‹ˆë‹¤.
    # ë§ˆë§ˆì˜ íŠ¹ë³„ êµì§€ì— ë”°ë¼ ì´ ë¡œê¹… ì‹œìŠ¤í…œ ë‚´ì—ì„œëŠ” ì´ëª¨ì§€ ì‚¬ìš©ì´ í—ˆìš©ë©ë‹ˆë‹¤.
    EMOJIS = {
        'VISION': 'ğŸ‘ï¸ ',   # ì‹œê° ì§€ëŠ¥ ê´€ë ¨
        'AGENT': 'ğŸ§ ',      # ì¸ê³µì§€ëŠ¥ ì¶”ë¡  ê´€ë ¨
        'MAIN': 'ğŸ“±',       # ë©”ì¸ UI ì‹¤í–‰ ê´€ë ¨
        'ROBOT': 'ğŸ¤–',      # ë¡œë´‡ í•˜ë“œì›¨ì–´ ì œì–´ ê´€ë ¨
        'EMOTION': 'ğŸ˜Š',    # ê°ì • ìƒíƒœ ë³€ê²½ ê´€ë ¨
        'ERROR': 'âŒ',      # ì˜¤ë¥˜ ë¡œê·¸
        'SUCCESS': 'âœ…',    # ì‘ì—… ì„±ê³µ ë¡œê·¸
        'DEBUG': 'ğŸ”',      # ë””ë²„ê¹… ì •ë³´
        'STREAM': 'ğŸ“¹',     # ì˜ìƒ ìŠ¤íŠ¸ë¦¬ë° ê´€ë ¨
        'LLM': 'ğŸ’¬',        # ì–¸ì–´ ëª¨ë¸ ëŒ€í™” ê´€ë ¨
        'TOOLS': 'ğŸ› ï¸',      # ì—ì´ì „íŠ¸ ë„êµ¬ ì‹¤í–‰ ê´€ë ¨
        'CONFIG': 'âš™ï¸'      # ì„¤ì • ì •ë³´ ê´€ë ¨
    }
    
    def format(self, record):
        """
        ì‹¤ì œ ë¡œê·¸ ë©”ì‹œì§€ê°€ ì¶œë ¥ë  ë•Œì˜ ëª¨ì–‘(í¬ë§·)ì„ ê²°ì •í•˜ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤.
        """
        # ë¡œê·¸ë¥¼ ë‚¨ê¸´ ëª¨ë“ˆì˜ ì´ë¦„ì„ ëŒ€ë¬¸ìë¡œ ê°€ì ¸ì˜µë‹ˆë‹¤ (ì˜ˆ: main -> MAIN).
        module_name = record.name.upper()
        
        # ë¯¸ë¦¬ ì •ì˜í•œ EMOJIS ë”•ì…”ë„ˆë¦¬ì—ì„œ ëª¨ë“ˆëª…ì— ë§ëŠ” ì´ëª¨ì§€ë¥¼ ì°¾ìŠµë‹ˆë‹¤.
        # ë§Œì•½ ëª©ë¡ì— ì—†ë‹¤ë©´ ğŸ“Œ ëª¨ì–‘ì„ ê¸°ë³¸ê°’ìœ¼ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
        emoji = self.EMOJIS.get(module_name, 'ğŸ“Œ')
        
        # ë¡œê·¸ ë ˆë²¨(INFO, ERROR ë“±)ì— ë§ëŠ” ìƒ‰ìƒì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
        level_name = record.levelname
        log_color = self.COLORS.get(level_name, '')
        
        # í˜„ì¬ ì‹œê°„ì„ "ë…„-ì›”-ì¼ ì‹œ:ë¶„:ì´ˆ" í˜•ì‹ì˜ ë¬¸ìì—´ë¡œ ë§Œë“­ë‹ˆë‹¤.
        current_time = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        
        # ìµœì¢…ì ìœ¼ë¡œ í„°ë¯¸ë„ì— ë³´ì—¬ì¤„ ë¡œê·¸ í•œ ì¤„ì„ ì¡°ë¦½í•©ë‹ˆë‹¤.
        # êµ¬ì„±: [ìƒ‰ìƒ][ì‹œê°„] [ì´ëª¨ì§€ ëª¨ë“ˆëª…] ë©”ì‹œì§€ [ìƒ‰ìƒí•´ì œ]
        formatted_message = (
            f"{log_color}[{current_time}] [{emoji} {module_name}] "
            f"{record.getMessage()}{self.RESET}"
        )
        return formatted_message


def get_logger(name):
    """
    í”„ë¡œê·¸ë¨ì˜ íŠ¹ì • ë¶€ë¶„(ëª¨ë“ˆ)ì—ì„œ ì‚¬ìš©í•  ë¡œê±° ê°ì²´ë¥¼ ìƒì„±í•˜ì—¬ ë°˜í™˜í•©ë‹ˆë‹¤.
    ì´ ë¡œê±°ëŠ” í„°ë¯¸ë„ ì¶œë ¥ê³¼ íŒŒì¼ ì €ì¥ì„ ë™ì‹œì— ìˆ˜í–‰í•©ë‹ˆë‹¤.
    """
    # name ì´ë¦„ìœ¼ë¡œ ë¡œê±° ì¸ìŠ¤í„´ìŠ¤ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
    new_logger = logging.getLogger(name)
    # ë¡œê·¸ì˜ ìˆ˜ì§‘ ë ˆë²¨ì„ DEBUG(ëª¨ë“  ë¡œê·¸ ìˆ˜ì§‘)ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.
    new_logger.setLevel(logging.DEBUG)
    
    # ê¸°ì¡´ì— ë“±ë¡ëœ í•¸ë“¤ëŸ¬ê°€ ìˆë‹¤ë©´ ì œê±°í•˜ì—¬ ë¡œê·¸ê°€ ì¤‘ë³µìœ¼ë¡œ ì°íˆëŠ” ê²ƒì„ ë°©ì§€í•©ë‹ˆë‹¤.
    if new_logger.handlers:
        new_logger.handlers.clear()
    
    # ===== í„°ë¯¸ë„ ì¶œë ¥ í•¸ë“¤ëŸ¬ ì„¤ì • =====
    # sys.stdout(í‘œì¤€ ì¶œë ¥)ì„ í†µí•´ í„°ë¯¸ë„ í™”ë©´ì— ë¡œê·¸ë¥¼ ë³´ëƒ…ë‹ˆë‹¤.
    stream_handler = logging.StreamHandler(sys.stdout)
    stream_handler.setLevel(logging.DEBUG)
    # ìœ„ì—ì„œ ì •ì˜í•œ ì»¬ëŸ¬ í¬ë§¤í„°ë¥¼ ì ìš©í•©ë‹ˆë‹¤.
    stream_handler.setFormatter(ColoredFormatter())
    
    # ===== íŒŒì¼ ì €ì¥ í•¸ë“¤ëŸ¬ ì„¤ì • =====
    # ë¡œê·¸ë¥¼ ì €ì¥í•  'logs' í´ë”ê°€ ì—†ë‹¤ë©´ ìë™ìœ¼ë¡œ ìƒì„±í•©ë‹ˆë‹¤.
    log_directory = "logs"
    os.makedirs(log_directory, exist_ok=True)
    
    # íŒŒì¼ëª…ì— í˜„ì¬ ë‚ ì§œì™€ ì‹œê°„ì„ í¬í•¨í•˜ì—¬ ì¤‘ë³µë˜ì§€ ì•Šê²Œ ë§Œë“­ë‹ˆë‹¤ (ì˜ˆ: maengchil_20251224.log).
    file_timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    log_file_path = os.path.join(log_directory, f"maengchil_{file_timestamp}.log")
    
    # íŒŒì¼ì— ë¡œê·¸ë¥¼ ê¸°ë¡í•˜ëŠ” í•¸ë“¤ëŸ¬ë¥¼ ìƒì„±í•©ë‹ˆë‹¤. í•œê¸€ ê¹¨ì§ ë°©ì§€ë¥¼ ìœ„í•´ utf-8ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
    file_handler = logging.FileHandler(log_file_path, encoding='utf-8')
    file_handler.setLevel(logging.DEBUG)
    # íŒŒì¼ì—ëŠ” ì»¬ëŸ¬ ì½”ë“œê°€ ë“¤ì–´ê°€ë©´ ë³´ê¸° í˜ë“¤ë¯€ë¡œ ìˆœìˆ˜ í…ìŠ¤íŠ¸ í˜•ì‹ìœ¼ë¡œ ì €ì¥í•©ë‹ˆë‹¤.
    file_log_format = logging.Formatter(
        '[%(asctime)s] [%(name)s] %(message)s',
        datefmt='%Y-%m-%d %H:%M:%S'
    )
    file_handler.setFormatter(file_log_format)
    
    # ë¡œê±° ê°ì²´ì— í„°ë¯¸ë„ í•¸ë“¤ëŸ¬ì™€ íŒŒì¼ í•¸ë“¤ëŸ¬ë¥¼ ëª¨ë‘ ì¶”ê°€í•©ë‹ˆë‹¤.
    new_logger.addHandler(stream_handler)
    new_logger.addHandler(file_handler)
    
    return new_logger


# ì´ íŒŒì¼ì´ ëª¨ë“ˆë¡œì„œ ë¶ˆë ¤ì˜¤ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ ì§ì ‘ ì‹¤í–‰ë  ë•Œë§Œ í…ŒìŠ¤íŠ¸ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤.
if __name__ == "__main__":
    test_logger = get_logger('MAIN')
    test_logger.info("ë¡œê±° ì´ˆê¸°í™”ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.")
    test_logger.debug("ìƒì„¸í•œ ë””ë²„ê·¸ ì •ë³´ë¥¼ ì¶œë ¥í•©ë‹ˆë‹¤.")
    test_logger.warning("ì‹œìŠ¤í…œ ì£¼ì˜ ì‚¬í•­ì´ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")
    test_logger.error("ì‹¤í–‰ ë„ì¤‘ ì˜¤ë¥˜ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.")