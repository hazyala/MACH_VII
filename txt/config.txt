================================================================================
# MACH VII (마하세븐, 별명: 맹칠) - 설정 & TODO 리스트
================================================================================
# 작성일: 2025-12-22 03:01 KST
# 환경: Ubuntu 22.04 LTS ARM64, Python 3.10+
# 전략: RealSense 직접 처리 + Streamlit 표시 (하이브리드)

================================================================================
## 🔧 환경 설정 (Configuration)
================================================================================

### RealSense D455 설정
REALSENSE_RESOLUTION = 640x480
REALSENSE_FPS = 15
REALSENSE_DEPTH_FORMAT = Z16
REALSENSE_COLOR_FORMAT = BGR8
REALSENSE_TIMEOUT_MS = 10000

### YOLO 설정
YOLO_MODEL = yolov11s
YOLO_CONFIDENCE_THRESHOLD = 0.5
YOLO_DEVICE = 0

### LLM 설정
LLM_VISION_MODEL = gemma3:4b
LLM_VISION_URL = http://localhost:11434
LLM_VISION_TEMPERATURE = 0.0

### Streamlit UI 설정 (수정)
STREAMLIT_LAYOUT = wide

UI_STRUCTURE:
  왼쪽 (2/3 너비): 실시간 카메라 + YOLO 박스 + 좌표
  오른쪽 (1/3 너비): 감정 GIF + 채팅

### 감정 GIF 설정 (준비 완료)
EMOTION_GIF_PATH = assets/gif/
EMOTION_STATES = idle, thinking, happy, sad, angry, confused

### 메모리 설정 (Phase 1: Session State만)
MEMORY_TYPE = session_state
# Phase 2에서 LAG 통합 예정

================================================================================
## 🎯 PHASE 1 최종 전략 (4시간 30분)
================================================================================

목표: 모든 기본 기능 동작 (최적화 X)
제외: 로봇팔, 벡터 애니메이션, LAG, DOFBOT

Vision 방식: RealSense 직접 처리 (RGB + Depth)
UI 렌더링: Streamlit (스레드 기반)

================================================================================
## 📋 PHASE 1 - 상세 TODO 리스트
================================================================================

### 1. 텍스트 파일 (현재)
  [x] config.txt (재정리 완료)
  [ ] .gitignore (기존 유지)

### 2. logger.py (30분)
  [ ] ColoredFormatter 클래스
  [ ] COLORS 딕셔너리 (DEBUG, INFO, WARNING, ERROR)
  [ ] EMOJIS 딕셔너리 (VISION, AGENT, MAIN, ROBOT, EMOTION, ERROR, etc)
  [ ] format() 메서드 구현
  [ ] get_logger() 함수 구현
  [ ] logs/ 디렉토리 자동 생성
  [ ] 파일 + 터미널 이중 핸들러
  [ ] 타임스탬프 포맷 설정

### 3. vision.py (45분) ⭐ 핵심!
  [ ] RealSense 파이프라인 초기화
      [ ] rs.pipeline() 생성
      [ ] RGB 스트림: 640x480, BGR8, 15fps
      [ ] Depth 스트림: 640x480, Z16, 15fps
  [ ] 카메라 intrinsic 파라미터 로드 (XYZ 변환용)
  [ ] YOLO11s 모델 로드
  [ ] VisionSystem 클래스 구현
  [ ] process_frame() 함수
      [ ] RGB + Depth 프레임 획득
      [ ] YOLO 추론
      [ ] 바운딩박스 그리기
      [ ] XYZ 좌표 계산 (픽셀 depth → 실제 거리 mm)
      [ ] 노이즈 필터링 (0 값 제외)
  [ ] 반환값: (annotated_frame, text_result, coordinates_list)
  [ ] FPS 로깅 (처리 시간 측정)
  [ ] 예외 처리 (카메라 미연결, 프레임 손실)

### 4. tools/ 패키지 (60분)
  [ ] tools/__init__.py
      [ ] import 문 작성
      [ ] TOOLS 리스트 정의
      [ ] __all__ 정의

  [ ] tools/vision_detect.py (12분)
      [ ] @tool decorator
      [ ] vision_detect(query: str) 함수
      [ ] st.session_state에서 결과 가져오기
      [ ] YOLO 텍스트 + XYZ 좌표 조합
      [ ] 로깅 추가

  [ ] tools/vision_analyze.py (12분)
      [ ] vision_analyze(query: str) 함수
      [ ] 현재 프레임 base64 인코딩
      [ ] VLM 호출 (Ollama)
      [ ] 응답 반환
      [ ] 예외 처리

  [ ] tools/find_location.py (8분)
      [ ] find_location(target: str) 함수
      [ ] st.session_state.last_coordinates 검색
      [ ] 대소문자 무시 매칭
      [ ] 좌표 반환
      [ ] 로깅 추가

  [ ] tools/robot_action.py (12분) ⭐ 시뮬레이션만
      [ ] robot_action(command: str) 함수
      [ ] wave, grab, push, home 명령어 처리
      [ ] 시뮬레이션 응답만 (실제 제어 X)
      [ ] 로봇 상태 업데이트
      [ ] 로깅 추가

  [ ] tools/emotion_set.py (8분)
      [ ] emotion_set(emotion: str) 함수
      [ ] 감정 상태 검증
      [ ] st.session_state.robot_state 업데이트
      [ ] 로깅 추가

  [ ] tools/memory_save.py (8분) ⭐ Session State만
      [ ] memory_save(key: str, value: str) 함수
      [ ] st.session_state.memory 초기화
      [ ] 타임스탬프 함께 저장
      [ ] 로깅 추가

  [ ] tools/memory_load.py (8분) ⭐ Session State만
      [ ] memory_load(query: str) 함수
      [ ] st.session_state.memory 조회
      [ ] 키워드 매칭
      [ ] 관련 기억 반환
      [ ] 로깅 추가

### 5. agent.py (30분)
  [ ] logger import
  [ ] tools import (from tools import TOOLS)
  [ ] ChatOllama 초기화 (gemma3:4b, localhost:11434)
  [ ] LLM 연결 테스트
  [ ] Agent 초기화 (ZERO_SHOT_REACT_DESCRIPTION)
  [ ] max_iterations = 10
  [ ] early_stopping_method = "generate"
  [ ] get_agent() 함수 구현
  [ ] 로깅 추가
  [ ] 예외 처리

### 6. main.py (45분) ⭐ 하이브리드 구조
  [ ] logger import & 초기화
  [ ] page_config (wide layout)
  
  [ ] session_state 초기화
      [ ] vision_system
      [ ] agent
      [ ] messages
      [ ] current_frame
      [ ] last_vision_result
      [ ] last_coordinates
      [ ] robot_state
      [ ] memory

  [ ] RealSense 백그라운드 스레드
      [ ] threading.Thread로 실행
      [ ] vision.process_frame() 루프
      [ ] session_state 업데이트 (15fps)

  [ ] Streamlit UI (메인 스레드)
      [ ] 레이아웃: col1(2/3), col2(1/3)
      
      [ ] col1: 실시간 비전
          [ ] 프레임 표시 (st.empty() + st.image())
          [ ] YOLO 박스 그려진 프레임
          [ ] 좌표 정보 텍스트
          [ ] 실시간 업데이트
      
      [ ] col2: 감정 & 채팅
          [ ] 감정 GIF 표시
          [ ] 감정 텍스트
          [ ] 채팅 메시지 히스토리
          [ ] 사용자 입력 박스
      
      [ ] check_and_react() 함수
          [ ] emotion_set("thinking")
          [ ] agent.run(prompt)
          [ ] 성공/실패 판단
          [ ] emotion_set() 호출
          [ ] 응답 저장 & 로깅

  [ ] 로깅 강화
      [ ] 사용자 명령 기록
      [ ] Vision 결과 기록
      [ ] Agent 실행 기록
      [ ] 감정 변화 기록

### 7. 기타 파일 (10분)
  [ ] requirements.txt 완성
      [ ] pyrealsense2
      [ ] ultralytics
      [ ] langchain
      [ ] langchain-community
      [ ] streamlit
      [ ] numpy
      [ ] opencv-python
      [ ] Pillow
      [ ] 기타

  [ ] README.md (Phase 2)

================================================================================
## 🧪 PHASE 1 테스트 항목
================================================================================

### 1. 로깅 테스트
  [ ] logger.py 단독 테스트
  [ ] 컬러 + 이모지 출력 확인
  [ ] 파일 + 터미널 저장 확인

### 2. Vision 테스트
  [ ] RealSense 카메라 연결 확인
  [ ] RGB + Depth 스트림 획득
  [ ] YOLO 모델 로드 및 추론
  [ ] XYZ 좌표 추출 (실제 거리 측정과 비교)
  [ ] FPS 측정 (15fps 유지)

### 3. Tools 테스트
  [ ] 각 도구 import 확인
  [ ] 각 도구 개별 호출 테스트
  [ ] 도구 로깅 확인

### 4. Agent 테스트
  [ ] Agent 초기화 확인
  [ ] LLM 연결 확인
  [ ] 간단한 질문으로 응답 테스트
  [ ] 도구 호출 순서 확인

### 5. Streamlit UI 테스트 (최종 목표)
  [ ] streamlit run main.py 실행
  [ ] 레이아웃 확인 (왼쪽 카메라, 오른쪽 감정+채팅)
  [ ] 실시간 카메라 스트리밍
  [ ] YOLO 박스 표시
  [ ] 좌표 정보 표시
  [ ] 감정 GIF 표시 (6개)
  [ ] 채팅 인터페이스 작동
  [ ] 로그 출력 확인
  [ ] 사용자 명령 → Vision → Agent → 응답 → 감정 변화

================================================================================
## 📊 PHASE 1 예상 소요 시간
================================================================================

logger.py       : 30분
vision.py       : 45분  ⭐ (RealSense + XYZ 핵심)
tools/ (7개)    : 60분
agent.py        : 30분
main.py         : 45분  ⭐ (하이브리드 스레드 구조)
기타 파일       : 10분
─────────────────────────────
합계            : 4시간 30분

목표: 2025-12-22 06:30 ~ 07:00 KST 완성

================================================================================
## 🎯 최종 체크리스트 (완성 기준)
================================================================================

UI:
  [ ] 왼쪽: 실시간 카메라 스트림 + YOLO 박스 + 좌표
  [ ] 오른쪽: 감정 GIF + 채팅
  [ ] 항상 스트리밍 (WebRTC 아님, RealSense 직접)

Vision:
  [ ] RealSense RGB + Depth 동시 획득
  [ ] YOLO 추론 + 박스 그리기
  [ ] XYZ 좌표 정확도 우수 (mm 단위)
  [ ] 15fps 안정적

Agent & Tools:
  [ ] 7개 도구 모두 동작
  [ ] Agent ReAct 루프 작동
  [ ] 도구 호출 순서 올바름

Emotion & Logging:
  [ ] 감정 GIF 6개 표시
  [ ] 터미널 + 파일 로그
  [ ] 이모지 + 컬러 출력

================================================================================
## 💡 핵심 포인트 (반드시 기억!)
================================================================================

1. RealSense 직접 처리 (WebRTC X)
   → RGB + Depth 동시 획득
   → XYZ 좌표 정확도 높음

2. 스레드 기반 구조
   → 백그라운드: RealSense 스트림 (15fps)
   → 프론트엔드: Streamlit UI (실시간 표시)

3. 한 화면에 모두
   → 왼쪽: 카메라 + YOLO + 좌표
   → 오른쪽: 감정 + 채팅

4. 감정 GIF 준비 완료
   → idle, thinking, happy, sad, angry, confused

5. Phase 1 범위
   → 기본 기능 100% 동작
   → 로봇팔 (X), 벡터 애니메이션 (X), LAG (X)

================================================================================
## 🚀 시작 명령어
================================================================================

# 개발 시작
1. logger.py 생성
2. vision.py 생성
3. tools/ 패키지 생성
4. agent.py 생성
5. main.py 생성
6. streamlit run main.py

# 로그 모니터링
tail -f logs/maengchil_*.log

================================================================================
